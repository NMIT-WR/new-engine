zerops:
  - setup: medusa
    build:
      envVariables:
        BACKEND_URL: ${MEDUSA_INSTANCE_URL}
        NX_DAEMON: false
      base: nodejs@22
      buildCommands:
        - bash ./scripts/build-medusa.sh
        # Move prod node_modules to apps/medusa-be (equivalent to Docker's COPY --from=build)
        - mv medusa-be-prod/node_modules apps/medusa-be/
      deployFiles:
        - apps/medusa-be/.medusa/server/~
        - apps/medusa-be/~node_modules
        - apps/medusa-be/~src/scripts/seed-files
        - apps/medusa-be/src/scripts/seed-files
        - apps/medusa-be/src/scripts
        - apps/medusa-be/tsconfig.json
      cache:
        - node_modules
    deploy:
      readinessCheck:
        httpGet:
          port: 9000
          path: /health
    run:
      base: nodejs@22
      envVariables:
        DATABASE_TYPE: postgres
        NODE_ENV: production
        BACKEND_URL: ${MEDUSA_INSTANCE_URL}
        STORE_CORS: ${NEXT_STORE_URL},${NEXT_STORE_DEMO_URL},${ANALOG_STORE_URL},https://demo-13d1-3000.prg1.zerops.app,https://wr-demo.netlify.app,https://n1-fe.netlify.app,http://localhost:5173,http://localhost:3000,http://localhost:3001,http://localhost:3002,http://localhost:3003
        ADMIN_CORS: ${NEXT_STORE_URL},${NEXT_STORE_DEMO_URL},${ANALOG_STORE_URL},https://demo-13d1-3000.prg1.zerops.app,https://wr-demo.netlify.app,https://n1-fe.netlify.app,http://localhost:5173,http://localhost:3000,http://localhost:3001,http://localhost:3002,http://localhost:3003
        AUTH_CORS: ${NEXT_STORE_URL},${NEXT_STORE_DEMO_URL},${ANALOG_STORE_URL},https://demo-13d1-3000.prg1.zerops.app,https://wr-demo.netlify.app,https://n1-fe.netlify.app,http://localhost:5173,http://localhost:3000,http://localhost:3001,http://localhost:3002,http://localhost:3003
        DATABASE_URL: postgresql://${db_user}:${db_password}@${db_hostname}:5432/${db_hostname}?sslmode=disable
        MINIO_BUCKET: ${storage_bucketName}
        MINIO_ENDPOINT: ${storage_apiUrl}
        MINIO_SECRET_KEY: ${storage_secretAccessKey}
        MINIO_ACCESS_KEY: ${storage_accessKeyId}
        REDIS_URL: redis://${redis_hostname}:6379
        MEILISEARCH_HOST: http://${search_hostname}:${search_port}
        MEILISEARCH_API_KEY: ${search_masterKey}
        SENTRY_DSN: ${MEDUSA_SENTRY_DSN}
        SENTRY_NAME: ${MEDUSA_SENTRY_NAME}
      initCommands:
        # with each deploy
        - zsc execOnce ${appVersionId}_migration -- npm run migrate
        - zsc execOnce ${appVersionId}_links -- npm run syncLinks
        # initial setup, happens once in service lifetime
        - zsc execOnce createInitialSuperadmin -- npm run createInitialSuperadmin
        - zsc execOnce seedInitialDataProd -- npm run seedInitialDataProd
        - zsc execOnce setInitialPublishableKeyProd -- npm run setInitialPublishableKeyProd
        - zsc execOnce seedNorthernProd -- npm run seedNorthernProd
        #- zsc execOnce addInitialSearchDocuments -- npm run addInitialSearchDocuments
      ports:
        - port: 9000
          httpSupport: true
      start: npm start
      healthCheck:
       httpGet:
         port: 9000
         path: /health
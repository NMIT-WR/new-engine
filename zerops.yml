zerops:
  - setup: medusa
    build:
      envVariables:
        BACKEND_URL: ${MEDUSA_INSTANCE_URL}
      base: nodejs@22
      buildCommands:
        # Remove everything in apps except medusa-be via regex
        - |
          shopt -s extglob
          rm -rf apps/!(medusa-be)
        - pnpm i
        - npm i -g nx
        - nx run medusa-be:build --verbose
        - cp -r apps/medusa-be/.medusa/server/public/ apps/medusa-be/
        - ls -la apps/medusa-be
      deployFiles:
        - .nx
        - nx.json
        - package.json
        - pnpm-lock.yaml
        - pnpm-workspace.yaml
        - apps/medusa-be/.medusa/server
        - apps/medusa-be/public
        - apps/medusa-be/package.json
        - apps/medusa-be/tsconfig.json
        - apps/medusa-be/node_modules
        - apps/medusa-be/medusa-config.ts
        - apps/medusa-be/instrumentation.ts
        - apps/medusa-be/src/scripts
        - tsconfig.json
        - node_modules
      cache: node_modules
    deploy:
      #readinessCheck:
      #  httpGet:
      #    port: 9000
      #    path: /health
    run:
      base: nodejs@22
      envVariables:
        DATABASE_TYPE: postgres
        NODE_ENV: production
        BACKEND_URL: ${MEDUSA_INSTANCE_URL}
        STORE_CORS: ${NEXT_STORE_URL},${ANALOG_STORE_URL},http://localhost:5173,http://localhost:3000
        DATABASE_URL: postgresql://${db_user}:${db_password}@${db_hostname}:5432/${db_hostname}?ssl_mode=disable
        MINIO_BUCKET: ${storage_bucketName}
        MINIO_ENDPOINT: ${storage_apiUrl}
        MINIO_SECRET_KEY: ${storage_secretAccessKey}
        MINIO_ACCESS_KEY: ${storage_accessKeyId}
        REDIS_URL: redis://${redis_hostname}:6379
        CACHE_REDIS_URL: redis://${redis_hostname}:6379
        EVENTS_REDIS_URL: redis://${redis_hostname}:6379
        MEILISEARCH_HOST: http://${search_hostname}:${search_port}
        MEILISEARCH_API_KEY: ${search_masterKey}
      initCommands:
        # with each deploy
        - zsc execOnce ${appVersionId}_migration -- nx run medusa-be:migrate --verbose
        - zsc execOnce ${appVersionId}_links -- nx run medusa-be:syncLinks --verbose
        # initial setup, happens once in service lifetime
        - zsc execOnce createInitialSuperadmin -- nx run medusa-be:createInitialSuperadmin --verbose
        - zsc execOnce seedInitialData -- nx run medusa-be:seedInitialData --verbose
        - zsc execOnce setInitialPublishableKey -- nx run medusa-be:setInitialPublishableKey --verbose
        - zsc execOnce addInitialSearchDocuments -- nx run medusa-be:addInitialSearchDocuments --verbose
      ports:
        - port: 9000
          httpSupport: true
      start: nx run medusa-be:start
      healthCheck:
        httpGet:
          port: 9000
          path: /health
  - setup: nextstore
    build:
      base: nodejs@22
      envVariables:
        MEDUSA_BACKEND_URL: ${MEDUSA_INSTANCE_URL}
        NEXT_PUBLIC_SEARCH_ENDPOINT: ${SEARCH_URL}
        NEXT_PUBLIC_SEARCH_API_KEY: ${RUNTIME_NEXT_PUBLIC_SEARCH_API_KEY}
        NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY: ${RUNTIME_NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY}
        NEXT_PUBLIC_BASE_URL: ${NEXT_STORE_URL}
        NEXT_PUBLIC_DEFAULT_REGION: ${RUNTIME_NEXT_PUBLIC_DEFAULT_REGION}
        NEXT_PUBLIC_FEATURE_SEARCH_ENABLED: ${RUNTIME_NEXT_PUBLIC_FEATURE_SEARCH_ENABLED}
        NEXT_PUBLIC_INDEX_NAME: ${RUNTIME_NEXT_PUBLIC_INDEX_NAME}
        OBJECT_STORAGE_API_URL: ${RUNTIME_OBJECT_STORAGE_API_URL}
      buildCommands:
        - pnpm i
        - npm i -g nx
        - nx run medusa-fe:build
      deployFiles:
        - .nx
        - nx.json
        - package.json
        - pnpm-lock.yaml
        - pnpm-workspace.yaml
        - node_modules
        - apps/medusa-fe/.next
        - apps/medusa-fe/next.config.js
        - apps/medusa-fe/node_modules
        - apps/medusa-fe/public
        - apps/medusa-fe/check-env-variables.js
      cache: node_modules
    run:
      base: nodejs@22
      start: nx run medusa-fe:start
      ports:
        - port: 8000
          httpSupport: true
      envVariables:
        MEDUSA_BACKEND_URL: ${MEDUSA_INSTANCE_URL}
        OBJECT_STORAGE_API_URL: ${storage_apiUrl}
        NEXT_PUBLIC_BASE_URL: ${NEXT_STORE_URL}
        NEXT_PUBLIC_SEARCH_ENDPOINT: ${SEARCH_URL}
        NEXT_PUBLIC_DEFAULT_REGION: de
        NEXT_PUBLIC_FEATURE_SEARCH_ENABLED: true
        NEXT_PUBLIC_INDEX_NAME: products
        NEXT_PUBLIC_SEARCH_API_KEY: ${search_defaultSearchKey}
        NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY: ${medusa_CHANNEL_PUBLISHABLE_KEY}

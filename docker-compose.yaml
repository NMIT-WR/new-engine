services:
  medusa-be:
    restart: unless-stopped
    container_name: wr_medusa_be
    build:
      context: .
      dockerfile: docker/development/medusa-be/Dockerfile
    volumes:
      - .:/var/www
    command: pnpm --filter medusa-be dev -- --inspect=0.0.0.0:9009
#    command: pnpm --filter medusa-be dev -- --inspect=0.0.0.0:9009
#    command: sh -c "pnpm --filter medusa-be build && pnpm --filter medusa-be start"
#    command: tail -f /dev/null
    ports:
      - "9000:9000"
      - "9009:9009"
      - "24678:24678"
    depends_on:
      - medusa-db
      - medusa-valkey
      - medusa-minio
      - medusa-meilisearch
    networks:
      - internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/app"]
      start_period: 10s
    environment:
      #LOG_LEVEL: debug
      DATABASE_TYPE: postgres
      DATABASE_URL: ${DC_DATABASE_URL}
      LEGACY_DATABASE_URL: ${DC_LEGACY_DATABASE_URL}
      MINIO_FILE_URL: ${DC_MINIO_FILE_URL}
      MINIO_REGION: ${DC_MINIO_REGION}
      MINIO_ENDPOINT: ${DC_MINIO_ENDPOINT}
      MINIO_BUCKET: ${DC_MINIO_BUCKET}
      MINIO_ACCESS_KEY: ${DC_MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${DC_MINIO_SECRET_KEY}
      REDIS_URL: ${DC_REDIS_URL}
      CACHE_REDIS_URL: ${DC_REDIS_URL}
      EVENTS_REDIS_URL: ${DC_REDIS_URL}
      WE_REDIS_URL: ${DC_REDIS_URL}
      MEILISEARCH_HOST: ${DC_MEILISEARCH_HOST}
      MEILISEARCH_API_KEY: ${DC_MEILISEARCH_API_KEY}
      STORE_CORS: ${DC_STORE_CORS}
      ADMIN_CORS: ${DC_ADMIN_CORS}
      AUTH_CORS: ${DC_AUTH_CORS}
      SENTRY_NAME: ${DC_SENTRY_NAME}
      SENTRY_DSN: ${DC_SENTRY_DSN}
      # PPL Fulfillment Provider
      PPL_ENABLED: ${DC_PPL_ENABLED:-1}
      PPL_CLIENT_ID: ${DC_PPL_CLIENT_ID}
      PPL_CLIENT_SECRET: ${DC_PPL_CLIENT_SECRET}
      PPL_ENVIRONMENT: ${DC_PPL_ENVIRONMENT:-testing}
      PPL_COD_BANK_ACCOUNT: ${DC_PPL_COD_BANK_ACCOUNT}
      PPL_COD_BANK_CODE: ${DC_PPL_COD_BANK_CODE}
      # Company Address (fallback sender for fulfillment providers)
      COMPANY_ADDRESS_NAME: ${DC_COMPANY_ADDRESS_NAME}
      COMPANY_ADDRESS_STREET: ${DC_COMPANY_ADDRESS_STREET}
      COMPANY_ADDRESS_CITY: ${DC_COMPANY_ADDRESS_CITY}
      COMPANY_ADDRESS_ZIP_CODE: ${DC_COMPANY_ADDRESS_ZIP_CODE}
      COMPANY_ADDRESS_COUNTRY: ${DC_COMPANY_ADDRESS_COUNTRY}
      COMPANY_ADDRESS_PHONE: ${DC_COMPANY_ADDRESS_PHONE}
      COMPANY_ADDRESS_EMAIL: ${DC_COMPANY_ADDRESS_EMAIL}
  medusa-valkey:
    image: valkey/valkey:8-alpine
    healthcheck:
      test: "[ $$(valkey-cli ping) = 'PONG' ]"
      start_period: 5s
      timeout: 3s
      interval: 1s
      retries: 5
    ports:
      - "6379:6379"
    volumes:
      - medusa-valkey-data:/data
    networks:
      - internal
  medusa-minio:
    image: minio/minio
    container_name: wr_medusa_minio
    ports:
      - "9003:9003"
      - "9004:9004"
    volumes:
      - medusa-minio-data:/data
    networks:
      - internal
    command: server /data --console-address ":9003" --address :9004
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9003"]
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
  medusa-meilisearch:
    image: getmeili/meilisearch:v1.20
    container_name: wr_medusa_meilisearch
    ports:
      - "7700:7700"
    volumes:
      - medusa-meilisearch-data:/meili_data
    networks:
      - internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      MEILI_MASTER_KEY: ${DC_MEILI_MASTER_KEY}
      MEILI_NO_ANALYTICS: true
  medusa-db:
    image: postgres:17.6-alpine
    restart: unless-stopped
    command: ["postgres", "-cshared_preload_libraries=pg_stat_statements"]
    ports:
      - "5432:5432"
    volumes:
      - ${DC_POSTGRES_VOLUME_DATA:-./.docker_data/db}:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: ["CMD", "pg_isready", "-d", "medusa"]
      start_period: 10s
      interval: 30s
      timeout: 60s
      retries: 3
    environment:
      POSTGRES_PASSWORD: root
      POSTGRES_USER: root
      POSTGRES_DB: medusa
      PGDATA: "/var/lib/postgresql/data"
  engine-db:
    image: mariadb:latest
    restart: no
    environment:
      MYSQL_ROOT_PASSWORD: 1234
      MYSQL_DATABASE: wrshop
      MYSQL_USER: wruser
      MYSQL_PASSWORD: 1234
    command: --sql_mode="NO_ENGINE_SUBSTITUTION"
    ports:
      - "3306:3306"
    volumes:
      - ./.docker_data/dbmysql:/var/lib/mysql
      - ./docker/development/mariadb/wr.cnf:/etc/mysql/conf.d/wr.cnf
    networks:
      - internal
  adminer:
    image: adminer
    restart: unless-stopped
    ports:
      - "8081:8080"
    depends_on:
      - medusa-db
    networks:
      - internal
    environment:
      ADMINER_DESIGN: nette
      ADMINER_DEFAULT_SERVER: medusa-db
      ADMINER_PLUGINS: "dump-json"
  caddy:
    build:
      context: ./docker/development/caddy
      dockerfile: Dockerfile
    cap_add:
      - NET_ADMIN
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    networks:
      - internal
    volumes:
      - ./docker/development/caddy/Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    extra_hosts:
      - host.docker.internal:host-gateway
networks:
  internal:
    driver: bridge

volumes:
  medusa-valkey-data:
  medusa-minio-data:
  medusa-meilisearch-data:
  caddy_data:
  caddy_config:

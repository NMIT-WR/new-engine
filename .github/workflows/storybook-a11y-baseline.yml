name: Storybook A11y Baseline (APCA)

on:
  push:
    branches:
      - master
    paths:
      - "libs/ui/**"
      - ".github/workflows/storybook-a11y.yml"
      - ".github/workflows/storybook-a11y-baseline.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-storybook:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: pnpm/action-setup@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Storybook (UI)
        run: pnpm -C libs/ui build:storybook

      - name: Upload Storybook static
        uses: actions/upload-artifact@v4
        with:
          name: storybook-static
          path: libs/ui/storybook-static

  storybook-a11y-baseline:
    runs-on: ubuntu-latest
    needs: build-storybook
    strategy:
      fail-fast: false
      matrix:
        theme: [light, dark]
    env:
      A11Y_REPORT_FAIL_ON_VIOLATIONS: "false"
      A11Y_REPORT_WRITE_JUNIT: "true"
      A11Y_REPORT_WAIT_MS: "30000"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Download Storybook static
        uses: actions/download-artifact@v4
        with:
          name: storybook-static
          path: libs/ui/storybook-static

      - name: Normalize Storybook static path
        run: |
          if [ -d "libs/ui/storybook-static/libs/ui/storybook-static" ]; then
            rm -rf libs/ui/storybook-static.tmp
            mv libs/ui/storybook-static/libs/ui/storybook-static libs/ui/storybook-static.tmp
            rm -rf libs/ui/storybook-static
            mv libs/ui/storybook-static.tmp libs/ui/storybook-static
          fi

      - name: Serve Storybook
        run: |
          python3 -m http.server 6006 --directory libs/ui/storybook-static &
          for i in {1..20}; do
            if curl -sf http://127.0.0.1:6006/ >/dev/null; then
              exit 0
            fi
            sleep 1
          done
          echo "Storybook server failed to start within timeout." >&2
          exit 1

      - name: Ensure a11y report directory
        run: mkdir -p "libs/ui/a11y-report/${{ matrix.theme }}"

      - name: Run a11y tests (${{ matrix.theme }} theme)
        id: a11y
        continue-on-error: true
        env:
          A11Y_REPORT_OUTPUT_DIR: a11y-report/${{ matrix.theme }}
        run: pnpm -C libs/ui exec test-storybook --url "http://127.0.0.1:6006/?globals=theme:${{ matrix.theme }}" --config-dir .storybook --maxWorkers 2 --testTimeout 60000

      - name: Upload baseline report (${{ matrix.theme }})
        if: always() && hashFiles(format('libs/ui/a11y-report/{0}/report.json', matrix.theme)) != ''
        uses: actions/upload-artifact@v4
        with:
          name: storybook-a11y-baseline-${{ matrix.theme }}
          path: libs/ui/a11y-report/${{ matrix.theme }}/report.json
